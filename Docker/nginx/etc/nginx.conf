user nginx;
worker_processes auto;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    access_log /dev/stdout;
    error_log  /dev/stderr debug;

    # Zone for 404 rate-limiting
    limit_req_zone $binary_remote_addr zone=not_found:10m rate=10r/m;


    map $http_upgrade $connection_upgrade {
        default upgrade;
        ""      close;
    }

    map $remote_addr $proxy_forwarded_elem {
        ~^[0-9.]+$        "for=$remote_addr";
        ~^[0-9A-Fa-f:.]+$ "for=\"[$remote_addr]\"";
        default           "for=unknown";
    }

    map $http_forwarded $proxy_add_forwarded {
        "~^(,[ \\t]*)*([!#$%&'*+.^_`|~0-9A-Za-z-]+=([!#$%&'*+.^_`|~0-9A-Za-z-]+|\"([\\t \\x21\\x23-\\x5B\\x5D-\\x7E\\x80-\\xFF]|\\\\[\\t \\x21-\\x7E\\x80-\\xFF])*\"))?(;([!#$%&'*+.^_`|~0-9A-Za-z-]+=([!#$%&'*+.^_`|~0-9A-Za-z-]+|\"([\\t \\x21\\x23-\\x5B\\x5D-\\x7E\\x80-\\xFF]|\\\\[\\t \\x21-\\x7E\\x80-\\xFF])*\"))?)*([ \\t]*,([ \\t]*([!#$%&'*+.^_`|~0-9A-Za-z-]+=([!#$%&'*+.^_`|~0-9A-Za-z-]+|\"([\\t \\x21\\x23-\\x5B\\x5D-\\x7E\\x80-\\xFF]|\\\\[\\t \\x21-\\x7E\\x80-\\xFF])*\"))?(;([!#$%&'*+.^_`|~0-9A-Za-z-]+=([!#$%&'*+.^_`|~0-9A-Za-z-]+|\"([\\t \\x21\\x23-\\x5B\\x5D-\\x7E\\x80-\\xFF]|\\\\[\\t \\x21-\\x7E\\x80-\\xFF])*\"))?)*)?)*$" "$http_forwarded, $proxy_forwarded_elem";
        default "$proxy_forwarded_elem";
    }


    server {
        listen 80;
        listen [::]:80;
        return 301 https://$host$request_uri;
    }

    server {
        listen                  443 ssl default_server;
        listen                  [::]:443 ssl default_server;

        ssl_reject_handshake    on;

        ssl_protocols           TLSv1.2 TLSv1.3;

        ssl_session_timeout     1h;
        ssl_session_cache       shared:SSL:10m;
    }

    server {
        listen                     443 ssl;
        listen                     [::]:443 ssl;
        http2                      on;

        server_name                MAIN_DOMAIN DIRECT_CONN_DOMAIN CDN_COMPAT_DOMAIN;

        ssl_certificate            /etc/letsencrypt/live/MAIN_DOMAIN/fullchain.pem;
        ssl_certificate_key        /etc/letsencrypt/live/MAIN_DOMAIN/privkey.pem;

        ssl_protocols              TLSv1.2 TLSv1.3;
        ssl_ciphers                TLS13_AES_128_GCM_SHA256:TLS13_AES_256_GCM_SHA384:TLS13_CHACHA20_POLY1305_SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305;
        ssl_prefer_server_ciphers  on;

        ssl_stapling               on;
        ssl_stapling_verify        on;
        resolver                   1.1.1.1 valid=60s;
        resolver_timeout           2s;

        client_header_buffer_size  8k;

        location @not_found {
            limit_req zone=not_found burst=5 nodelay;
            return 404;
        }

        location = VLESS_WS_PATH {
            if ($http_upgrade != "websocket") {
                return 404;
            }

            proxy_pass                          http://sing-box:9443;
            proxy_http_version                  1.1;
            proxy_set_header Upgrade            $http_upgrade;
            proxy_set_header Connection         "upgrade";
            proxy_set_header X-Real-IP          $remote_addr;
            proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
            proxy_set_header Host               $host;
            proxy_redirect                      off;
        }

        location = /VLESS_GRPC_PATH {
            if ($content_type !~ "application/grpc") {
                return 404;
            }

            grpc_pass                    grpc://sing-box:9444;
            grpc_read_timeout            1h;
            grpc_send_timeout            1h;
            grpc_set_header X-Real-IP    $remote_addr;
            grpc_socket_keepalive        on;

            client_body_buffer_size      1m;
            client_body_timeout          1h;
            client_max_body_size         0;
        }
        
        # WordPress specific
        location / {
            proxy_pass http://wordpress:80;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
            
            # WordPress may need these for file uploads
            proxy_connect_timeout 300s;
            proxy_send_timeout 300s;
            proxy_read_timeout 300s;
        }
        
        # Handle PHP file uploads
        location ~ \.php$ {
            proxy_pass http://wordpress:80;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
        }
        
        # Static files caching
        location ~* \.(jpg|jpeg|png|gif|ico|css|js|pdf|txt)$ {
            root /var/www/html;
            autoindex off;
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
        
        location / {
            root /var/www/html;
            index index.html;
            try_files $uri $uri/ @not_found;

            # Apply 404 rate limit only
            limit_req zone=not_found burst=3 nodelay;
        }
    }
}